#!/usr/bin/env php
<?php
/**
 * CLI wrapper for KicksDB Product Discovery
 *
 * Auto-discovers popular reselling sneakers from KicksDB using a single
 * paginated query, deduplicates against the GS feed SKU cache, and saves
 * an assortment file for use by the kicksdb-sync pipeline.
 *
 * Outputs: data/kicksdb-assortment.json
 *
 * @package ResellPiacenza\Import
 */

require __DIR__ . '/../vendor/autoload.php';

use Monolog\Logger;
use ResellPiacenza\Support\Config;
use ResellPiacenza\Support\LoggerFactory;
use ResellPiacenza\KicksDb\Client;

// ============================================================================
// CLI
// ============================================================================

if (in_array('--help', $argv) || in_array('-h', $argv)) {
    echo <<<HELP
KicksDB Product Discovery
Discovers popular reselling sneakers from KicksDB for automated import.

Usage:
  bin/kicksdb-discover [options]

Options:
  --limit=N               Max products in assortment (default: from KICKSDB_ASSORTMENT_SIZE or 800)
  --query=TERM            Override search query (default: from KICKSDB_DISCOVERY_QUERY or "sneakers")
  --skip-dedup            Don't exclude SKUs already in the GS feed
  --dry-run               Preview without saving
  --verbose, -v           Detailed output
  --help, -h              Show help

Output:
  data/kicksdb-assortment.json - Discovered product assortment

How it works:
  1. Loads GS SKU cache (data/gs-sku-cache.json) for deduplication
  2. Paginates KicksDB browse results for a generic query (e.g. "sneakers")
  3. Skips products already in the GS feed (on-the-fly filtering)
  4. Collects products until target assortment size is reached
  5. Sorts by rank (most popular first), saves top N

Examples:
  bin/kicksdb-discover                                # Default (800 products)
  bin/kicksdb-discover --limit=100 --verbose          # Top 100, detailed
  bin/kicksdb-discover --query=jordans --limit=50     # Custom query
  bin/kicksdb-discover --skip-dedup                   # Don't exclude GS SKUs

HELP;
    exit(0);
}

$opt_verbose = in_array('--verbose', $argv) || in_array('-v', $argv);
$opt_dry_run = in_array('--dry-run', $argv);
$opt_skip_dedup = in_array('--skip-dedup', $argv);
$opt_limit = null;
$opt_query = null;

foreach ($argv as $arg) {
    if (strpos($arg, '--limit=') === 0) {
        $opt_limit = (int) str_replace('--limit=', '', $arg);
    }
    if (strpos($arg, '--query=') === 0) {
        $opt_query = str_replace('--query=', '', $arg);
    }
}

// ============================================================================
// Setup
// ============================================================================

$config = Config::load();
$start_time = microtime(true);

$logger = LoggerFactory::create('Discover', [
    'file' => Config::projectRoot() . '/logs/kicksdb-discover.log',
    'console_level' => $opt_verbose ? Logger::DEBUG : Logger::INFO,
]);

$assortment_size = $opt_limit ?? ($config['pricing']['kicksdb_assortment_size'] ?? 800);
$query = $opt_query ?? ($config['pricing']['kicksdb_discovery_query'] ?? 'sneakers');
$page_size = $config['pricing']['kicksdb_discovery_page_size'] ?? 50;
$market = $config['pricing']['kicksdb_market'] ?? 'IT';

$logger->info('');
$logger->info('========================================');
$logger->info('  KicksDB Product Discovery');
$logger->info('========================================');
$logger->info("  Target: {$assortment_size} products");
$logger->info("  Query:  \"{$query}\"");
$logger->info("  Market: {$market}");
if ($opt_dry_run) {
    $logger->warning('  DRY RUN');
}
if ($opt_skip_dedup) {
    $logger->info('  Skipping GS deduplication');
}
$logger->info('');

$api_key = $config['pricing']['kicksdb_api_key'] ?? '';
if (empty($api_key)) {
    $logger->error('KICKSDB_API_KEY not set in .env');
    exit(1);
}

$client = new Client($api_key, [
    'base_url' => $config['pricing']['kicksdb_base_url'] ?? 'https://api.kicks.dev/v3',
], $logger);

// ============================================================================
// Step 1: Load GS SKU cache for deduplication
// ============================================================================

$gs_skus = [];
$gs_excluded = 0;

if (!$opt_skip_dedup) {
    $logger->info('Step 1: Loading GS SKU cache...');

    $cache_file = Config::projectRoot() . '/data/gs-sku-cache.json';
    $feed_file = Config::projectRoot() . '/data/feed-wc-latest.json';

    if (file_exists($cache_file)) {
        $cached = json_decode(file_get_contents($cache_file), true);
        if (is_array($cached)) {
            $gs_skus = array_flip($cached);
            $logger->info("  Loaded " . count($gs_skus) . " GS SKUs from cache");
        } else {
            $logger->warning("  Could not parse GS SKU cache, skipping dedup");
        }
    } elseif (file_exists($feed_file)) {
        // Fallback: parse the full GS feed
        $logger->info("  Cache not found, falling back to {$feed_file}");
        $gs_feed = json_decode(file_get_contents($feed_file), true);
        if (is_array($gs_feed)) {
            foreach ($gs_feed as $product) {
                $sku = $product['sku'] ?? null;
                if ($sku) {
                    $gs_skus[$sku] = true;
                }
            }
            $logger->info("  Loaded " . count($gs_skus) . " GS SKUs from feed");
        } else {
            $logger->warning("  Could not parse GS feed, skipping dedup");
        }
    } else {
        $logger->info("  No GS data found, skipping dedup");
    }
} else {
    $logger->info('Step 1: Skipped (--skip-dedup)');
}

// ============================================================================
// Step 2: Paginate KicksDB browse results
// ============================================================================

$logger->info('');
$logger->info('Step 2: Browsing KicksDB for popular products...');

$all_products = []; // Keyed by SKU for dedup
$api_calls = 0;

// Over-fetch by 20% to account for GS exclusions and SKU-less items
$fetch_target = (int) ceil($assortment_size * 1.2);
$max_pages = (int) ceil(($fetch_target + count($gs_skus)) / $page_size) + 5; // extra pages buffer

for ($page = 1; $page <= $max_pages; $page++) {
    $logger->debug("  Page {$page} (limit={$page_size}, collected=" . count($all_products) . "/{$assortment_size})");

    $result = $client->browseProducts($query, $page_size, $market, $page);
    $api_calls++;

    if ($result === null) {
        $logger->warning("  API returned null at page {$page}");
        break;
    }

    $items = $result['data'] ?? [];
    if (empty($items)) {
        $logger->debug("  No more results at page {$page}");
        break;
    }

    foreach ($items as $item) {
        $sku = $item['sku'] ?? null;
        if (!$sku || isset($all_products[$sku])) {
            continue;
        }

        // On-the-fly GS deduplication
        if (isset($gs_skus[$sku])) {
            $gs_excluded++;
            continue;
        }

        $all_products[$sku] = [
            'sku' => $sku,
            'name' => $item['title'] ?? $item['name'] ?? '',
            'brand' => $item['brand'] ?? '',
            'slug' => $item['slug'] ?? '',
            'rank' => $item['rank'] ?? 999999,
            'weekly_orders' => $item['weekly_orders'] ?? 0,
            'image_url' => $item['image'] ?? $item['image_url'] ?? '',
            'product_type' => 'sneakers',
        ];
    }

    // Stop early if we have enough products
    if (count($all_products) >= $fetch_target) {
        $logger->debug("  Reached fetch target ({$fetch_target}), stopping pagination");
        break;
    }

    // Stop paging if fewer results than requested (last page)
    if (count($items) < $page_size) {
        break;
    }

    // Throttle between pages
    usleep(200000); // 200ms
}

$logger->info("  Discovered: " . count($all_products) . " unique products ({$api_calls} API calls)");
if ($gs_excluded > 0) {
    $logger->info("  GS SKUs skipped: {$gs_excluded}");
}

if (empty($all_products)) {
    $logger->error('No products discovered from KicksDB.');
    exit(1);
}

// ============================================================================
// Step 3: Sort by popularity and apply limit
// ============================================================================

$logger->info('');
$logger->info('Step 3: Sorting by popularity and applying limit...');

// Sort by rank ascending (lower rank = more popular)
$products = array_values($all_products);
usort($products, function ($a, $b) {
    return ($a['rank'] ?? 999999) - ($b['rank'] ?? 999999);
});

// Apply limit
if (count($products) > $assortment_size) {
    $products = array_slice($products, 0, $assortment_size);
}

$logger->info("  Final assortment: " . count($products) . " products");

if ($opt_verbose && count($products) > 0) {
    $logger->debug("  Top 10 by rank:");
    foreach (array_slice($products, 0, 10) as $p) {
        $logger->debug("    rank={$p['rank']} orders={$p['weekly_orders']} {$p['brand']} {$p['sku']} - {$p['name']}");
    }
}

// ============================================================================
// Step 4: Save assortment
// ============================================================================

if (!$opt_dry_run) {
    $data_dir = Config::projectRoot() . '/data';
    if (!is_dir($data_dir)) {
        mkdir($data_dir, 0755, true);
    }

    $output = [
        'discovered_at' => date('c'),
        'total' => count($products),
        'gs_skus_excluded' => $gs_excluded,
        'query' => $query,
        'market' => $market,
        'products' => $products,
    ];

    $output_file = $data_dir . '/kicksdb-assortment.json';
    file_put_contents(
        $output_file,
        json_encode($output, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE)
    );

    $logger->info('');
    $logger->info("Saved to {$output_file}");
} else {
    $logger->info('');
    $logger->info('[DRY RUN] Would save ' . count($products) . ' products to data/kicksdb-assortment.json');
}

// ============================================================================
// Summary
// ============================================================================

$duration = round(microtime(true) - $start_time, 1);

$logger->info('');
$logger->info('========================================');
$logger->info('  DISCOVERY SUMMARY');
$logger->info('========================================');
$logger->info("  Query:             \"{$query}\"");
$logger->info("  API calls:         {$api_calls}");
$logger->info("  Products found:    " . (count($all_products) + $gs_excluded));
$logger->info("  GS SKUs excluded:  {$gs_excluded}");
$logger->info("  Final assortment:  " . count($products));
$logger->info("  Duration:          {$duration}s");
$logger->info('========================================');

exit(0);
